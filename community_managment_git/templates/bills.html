<!-- templates/bills.html -->
{% extends "base.html" %}

{% block title %}Bills - Community Management{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page">
    <i class="fas fa-file-invoice-dollar"></i> Bills
</li>
{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1><i class="fas fa-file-invoice-dollar"></i> {{ 'Bills Management' if user_role == 'admin' else 'My Bills' }}</h1>
        <p>{{ 'Manage all community bills and invoices' if user_role == 'admin' else 'View your bills and payment status' }}</p>
    </div>
    <div>
        <button class="btn btn-outline-success me-2" onclick="exportBills()" data-bs-toggle="tooltip" title="Export bills to Excel">
            <i class="fas fa-file-excel"></i> Export
        </button>
        {% if user_role == 'admin' %}
        <a href="{{ url_for('generate_bills') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Generate Bills
        </a>
        {% endif %}
    </div>
</div>

<!-- Enhanced Quick Stats with Real-time Updates -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="quick-stats">
            <h6>Total Bills</h6>
            <div class="stat-value" id="totalBills">{{ pagination.total if pagination else 0 }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="quick-stats success">
            <h6>Paid Bills</h6>
            <div class="stat-value" id="paidBills">{{ bills|selectattr('status', 'equalto', 'paid')|list|length if bills else 0 }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="quick-stats warning">
            <h6>Pending</h6>
            <div class="stat-value" id="pendingBills">{{ bills|selectattr('status', 'equalto', 'pending')|list|length if bills else 0 }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="quick-stats" style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);">
            <h6>Overdue</h6>
            <div class="stat-value" id="overdueBills">{{ bills|selectattr('status', 'equalto', 'overdue')|list|length if bills else 0 }}</div>
        </div>
    </div>
</div>

<!-- Enhanced Filter Section with Better Organization -->
<div class="card mb-4" id="filtersCard">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="fas fa-filter"></i> Filters & Search</h6>
        <button class="btn btn-sm btn-outline-light" onclick="toggleFilters()" id="toggleFiltersBtn">
            <i class="fas fa-chevron-up"></i> Collapse
        </button>
    </div>
    <div class="card-body" id="filtersBody">
        <div class="row align-items-center">
            <div class="col-md-3">
                <label for="searchInput" class="form-label">Search:</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" 
                           placeholder="House number, owner..." onkeyup="filterBills()"
                           data-bs-toggle="tooltip" title="Search by house number, owner name, or billing cycle">
                    <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()" data-bs-toggle="tooltip" title="Clear search">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-2">
                <label for="billTypeFilter" class="form-label">Bill Type:</label>
                <select class="form-select" id="billTypeFilter" onchange="filterBills()">
                    <option value="all" {% if current_filter == 'all' %}selected{% endif %}>All Bills</option>
                    <option value="maintenance" {% if current_filter == 'maintenance' %}selected{% endif %}>Maintenance</option>
                    <option value="water" {% if current_filter == 'water' %}selected{% endif %}>Water</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="yearFilter" class="form-label">Year:</label>
                <select class="form-select" id="yearFilter" onchange="applyFilters()">
                    <option value="all" {% if current_year == 'all' %}selected{% endif %}>All Years</option>
                    {% for year in available_years %}
                    <option value="{{ year.year }}" {% if current_year == year.year|string %}selected{% endif %}>{{ year.year }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="statusFilter" class="form-label">Status:</label>
                <select class="form-select" id="statusFilter" onchange="filterBills()">
                    <option value="all">All Status</option>
                    <option value="paid">‚úÖ Paid</option>
                    <option value="pending">‚è≥ Pending</option>
                    <option value="overdue">‚ö†Ô∏è Overdue</option>
                    <option value="partially_paid">üîÑ Partial</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="amountFilter" class="form-label">Amount Range:</label>
                <select class="form-select" id="amountFilter" onchange="filterBills()">
                    <option value="all">All Amounts</option>
                    <option value="high">High (>‚Çπ5,000)</option>
                    <option value="medium">Medium (‚Çπ1,000-‚Çπ5,000)</option>
                    <option value="low">Low (<‚Çπ1,000)</option>
                </select>
            </div>
            <div class="col-md-1 text-end">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button class="btn btn-outline-secondary" onclick="clearAllFilters()" data-bs-toggle="tooltip" title="Clear all filters">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Enhanced Filter Summary with Real-time Updates -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        Showing <span id="visibleCount">{{ bills|length if bills else 0 }}</span> of {{ pagination.total if pagination else 0 }} bills
                        {% if current_filter != 'all' %}‚Ä¢ Filter: <span class="badge bg-info">{{ current_filter|title }}</span>{% endif %}
                        {% if current_year and current_year != 'all' %}‚Ä¢ Year: <span class="badge bg-secondary">{{ current_year }}</span>{% endif %}
                        <span id="activeFilters"></span>
                    </small>
                    <small class="text-success">
                        <i class="fas fa-rupee-sign"></i> Visible Total: <span id="visibleAmount">‚Çπ0.00</span>
                    </small>
                </div>
            </div>
        </div>
        
        <!-- Advanced Filter Options (Initially Hidden) -->
        <div class="row mt-3" id="advancedFilters" style="display: none;">
            <div class="col-12">
                <div class="border-top pt-3">
                    <h6><i class="fas fa-sliders-h"></i> Advanced Filters</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <label for="dateFromFilter" class="form-label">From Date:</label>
                            <input type="date" class="form-control form-control-sm" id="dateFromFilter" onchange="filterBills()">
                        </div>
                        <div class="col-md-3">
                            <label for="dateToFilter" class="form-label">To Date:</label>
                            <input type="date" class="form-control form-control-sm" id="dateToFilter" onchange="filterBills()">
                        </div>
                        <div class="col-md-3">
                            <label for="sortBy" class="form-label">Sort By:</label>
                            <select class="form-select form-select-sm" id="sortBy" onchange="applySorting()">
                                <option value="default">Default Order</option>
                                <option value="amount_desc">Amount (High to Low)</option>
                                <option value="amount_asc">Amount (Low to High)</option>
                                <option value="date_desc">Date (Newest First)</option>
                                <option value="date_asc">Date (Oldest First)</option>
                                <option value="house_asc">House Number (A-Z)</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button class="btn btn-sm btn-outline-primary" onclick="toggleAdvancedFilters()">
                                    <i class="fas fa-eye-slash"></i> Hide Advanced
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Show Advanced Filters Button -->
        <div class="text-center mt-2">
            <button class="btn btn-sm btn-outline-info" onclick="toggleAdvancedFilters()" id="showAdvancedBtn">
                <i class="fas fa-sliders-h"></i> Show Advanced Filters
            </button>
        </div>
    </div>
</div>

<!-- Bills Table with Enhanced Features -->
<div class="card">
    <div class="card-body">
        {% if bills %}
        <div class="table-responsive">
            <table class="table" id="billsTable">
                <thead>
                    <tr>
                        {% if user_role == 'admin' %}
                        <th onclick="sortBillsTable(0)" style="cursor: pointer;">
                            House <i class="fas fa-sort text-muted"></i>
                        </th>
                        {% endif %}
                        <th onclick="sortBillsTable({{ '1' if user_role == 'admin' else '0' }})" style="cursor: pointer;">
                            Bill Type <i class="fas fa-sort text-muted"></i>
                        </th>
                        <th onclick="sortBillsTable({{ '2' if user_role == 'admin' else '1' }})" style="cursor: pointer;">
                            Billing Cycle <i class="fas fa-sort text-muted"></i>
                        </th>
                        <th>Generation Date</th>
                        <th>Due Date 
                            <i class="fas fa-question-circle help-icon" 
                               data-bs-toggle="tooltip" 
                               title="Bills are typically due 15 days after generation"></i>
                        </th>
                        <th onclick="sortBillsTable({{ '5' if user_role == 'admin' else '4' }})" style="cursor: pointer;">
                            Total Due <i class="fas fa-sort text-muted"></i>
                        </th>
                        <th>Paid</th>
                        <th onclick="sortBillsTable({{ '7' if user_role == 'admin' else '6' }})" style="cursor: pointer;">
                            Balance <i class="fas fa-sort text-muted"></i>
                        </th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bill in bills %}
                    <tr data-status="{{ bill.status }}" 
                        data-bill-type="{{ bill.bill_type }}" 
                        data-amount="{{ bill.total_amount_due }}"
                        data-generation-date="{{ bill.generation_date }}"
                        data-due-date="{{ bill.due_date }}">
                        {% if user_role == 'admin' %}
                        <td>
                            <strong>{{ bill.house_number }}</strong><br>
                            <small class="text-muted">{{ bill.owner_name }}</small>
                        </td>
                        {% endif %}
                        <td>
                            {% if bill.bill_type == 'maintenance' %}
                                <span class="badge bg-success"><i class="fas fa-tools"></i> Maintenance</span>
                            {% elif bill.bill_type == 'water' %}
                                <span class="badge bg-info"><i class="fas fa-tint"></i> Water</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ bill.bill_type|title }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <strong>{{ bill.billing_cycle }}</strong>
                            <i class="fas fa-copy text-muted ms-1" style="cursor: pointer;" 
                               onclick="copyToClipboard('{{ bill.billing_cycle }}')" 
                               data-bs-toggle="tooltip" title="Copy billing cycle"></i>
                        </td>
                        <td>{{ bill.generation_date }}</td>
                        <td>
                            <span class="{% if bill.status == 'overdue' %}text-danger{% else %}text-muted{% endif %}">
                                {{ bill.due_date }}
                                {% if bill.status == 'overdue' %}
                                    <i class="fas fa-exclamation-triangle text-danger ms-1" 
                                       data-bs-toggle="tooltip" title="This bill is overdue"></i>
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <strong>‚Çπ{{ "%.2f"|format(bill.total_amount_due) }}</strong>
                            <i class="fas fa-copy text-muted ms-1" style="cursor: pointer;" 
                               onclick="copyToClipboard('{{ bill.total_amount_due }}')" 
                               data-bs-toggle="tooltip" title="Copy amount"></i>
                        </td>
                        <td>‚Çπ{{ "%.2f"|format(bill.total_amount_paid) }}</td>
                        <td>
                            <strong class="{% if bill.current_balance > 0 %}text-danger{% else %}text-success{% endif %}">
                                ‚Çπ{{ "%.2f"|format(bill.current_balance) }}
                            </strong>
                        </td>
                        <td>
                            {% if bill.status == 'paid' %}
                                <span class="badge bg-success"><i class="fas fa-check"></i> Paid</span>
                            {% elif bill.status == 'partially_paid' %}
                                <span class="badge bg-warning"><i class="fas fa-clock"></i> Partial</span>
                            {% elif bill.status == 'overdue' %}
                                <span class="badge bg-danger"><i class="fas fa-exclamation-triangle"></i> Overdue</span>
                            {% else %}
                                <span class="badge bg-secondary"><i class="fas fa-hourglass-half"></i> Pending</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-info" onclick="viewBillDetails({{ bill.id }})"
                                        data-bs-toggle="tooltip" title="View bill details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="printBill({{ bill.id }})"
                                        data-bs-toggle="tooltip" title="Print bill">
                                    <i class="fas fa-print"></i>
                                </button>
                                {% if user_role == 'admin' and bill.current_balance > 0 %}
                                <button class="btn btn-sm btn-outline-primary" onclick="recordQuickPayment({{ bill.id }})"
                                        data-bs-toggle="tooltip" title="Record payment">
                                    <i class="fas fa-credit-card"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-file-invoice fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No Bills Found</h4>
            <p class="text-muted">
                {% if user_role == 'admin' %}
                    No bills have been generated yet. Start by generating bills for a billing cycle.
                    <br><a href="{{ url_for('generate_bills') }}" class="btn btn-primary mt-2">
                        <i class="fas fa-plus"></i> Generate First Bills
                    </a>
                {% else %}
                    No bills have been generated for your house yet.
                {% endif %}
            </p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Enhanced Pagination -->
{% if pagination.pages > 1 %}
<div class="d-flex justify-content-between align-items-center mt-4">
    <div>
        <small class="text-muted">
            <i class="fas fa-info-circle"></i>
            Showing {{ ((pagination.page - 1) * pagination.per_page + 1) }} to 
            {{ (pagination.page * pagination.per_page) if pagination.page < pagination.pages else pagination.total }} 
            of {{ pagination.total }} records
        </small>
    </div>
    <nav>
        <ul class="pagination">
            {% if pagination.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('bills', bill_type=current_filter, year=current_year, page=pagination.prev_num) }}">
                    <i class="fas fa-chevron-left"></i> Previous
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link"><i class="fas fa-chevron-left"></i> Previous</span>
            </li>
            {% endif %}
            
            {% for page_num in range(1, pagination.pages + 1) %}
                {% if page_num == pagination.page %}
                <li class="page-item active">
                    <span class="page-link">{{ page_num }}</span>
                </li>
                {% elif page_num == 1 or page_num == pagination.pages or (page_num >= pagination.page - 2 and page_num <= pagination.page + 2) %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('bills', bill_type=current_filter, year=current_year, page=page_num) }}">{{ page_num }}</a>
                </li>
                {% elif page_num == pagination.page - 3 or page_num == pagination.page + 3 %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
                {% endif %}
            {% endfor %}
            
            {% if pagination.has_next %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('bills', bill_type=current_filter, year=current_year, page=pagination.next_num) }}">
                    Next <i class="fas fa-chevron-right"></i>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">Next <i class="fas fa-chevron-right"></i></span>
            </li>
            {% endif %}
        </ul>
    </nav>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Enhanced search and filter functionality with real-time updates
function filterBills() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const billTypeFilter = document.getElementById('billTypeFilter').value;
    const amountFilter = document.getElementById('amountFilter').value;
    const dateFromFilter = document.getElementById('dateFromFilter') ? document.getElementById('dateFromFilter').value : '';
    const dateToFilter = document.getElementById('dateToFilter') ? document.getElementById('dateToFilter').value : '';
    
    const table = document.getElementById('billsTable');
    if (!table) return;
    
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    let visibleCount = 0;
    let visibleAmount = 0;
    let statusCounts = { paid: 0, pending: 0, overdue: 0, partially_paid: 0 };

    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        let searchMatch = true;
        let statusMatch = true;
        let billTypeMatch = true;
        let amountMatch = true;
        let dateMatch = true;

        // Search match
        if (searchTerm) {
            const rowText = row.textContent.toLowerCase();
            searchMatch = rowText.includes(searchTerm);
        }

        // Status match
        if (statusFilter !== 'all') {
            const rowStatus = row.getAttribute('data-status');
            statusMatch = rowStatus === statusFilter;
        }

        // Bill type match - this was missing!
        if (billTypeFilter !== 'all') {
            const rowBillType = row.getAttribute('data-bill-type');
            billTypeMatch = rowBillType === billTypeFilter;
        }

        // Amount match
        if (amountFilter !== 'all') {
            const amount = parseFloat(row.getAttribute('data-amount')) || 0;
            switch (amountFilter) {
                case 'high':
                    amountMatch = amount > 5000;
                    break;
                case 'medium':
                    amountMatch = amount >= 1000 && amount <= 5000;
                    break;
                case 'low':
                    amountMatch = amount < 1000;
                    break;
            }
        }

        // Date range match
        if (dateFromFilter || dateToFilter) {
            const genDate = row.getAttribute('data-generation-date');
            if (dateFromFilter && genDate < dateFromFilter) dateMatch = false;
            if (dateToFilter && genDate > dateToFilter) dateMatch = false;
        }

        if (searchMatch && statusMatch && billTypeMatch && amountMatch && dateMatch) {
            row.style.display = '';
            visibleCount++;
            
            // Update visible amount and status counts
            const amount = parseFloat(row.getAttribute('data-amount')) || 0;
            const status = row.getAttribute('data-status');
            visibleAmount += amount;
            if (statusCounts.hasOwnProperty(status)) {
                statusCounts[status]++;
            }
        } else {
            row.style.display = 'none';
        }
    }

    // Update counts in real-time
    updateVisibleCounts(visibleCount, visibleAmount, statusCounts);
    updateActiveFilters();
}

function updateVisibleCounts(count, amount, statusCounts) {
    const visibleCountEl = document.getElementById('visibleCount');
    const visibleAmountEl = document.getElementById('visibleAmount');
    
    if (visibleCountEl) visibleCountEl.textContent = count;
    if (visibleAmountEl) visibleAmountEl.textContent = '‚Çπ' + amount.toFixed(2);
    
    // Update stats cards if they exist
    const paidBillsElement = document.getElementById('paidBills');
    const pendingBillsElement = document.getElementById('pendingBills');
    const overdueBillsElement = document.getElementById('overdueBills');
    
    if (paidBillsElement) paidBillsElement.textContent = statusCounts.paid || 0;
    if (pendingBillsElement) pendingBillsElement.textContent = statusCounts.pending || 0;
    if (overdueBillsElement) overdueBillsElement.textContent = statusCounts.overdue || 0;
}

function updateActiveFilters() {
    const activeFilters = [];
    
    // Check for active filters
    const searchTerm = document.getElementById('searchInput').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const billTypeFilter = document.getElementById('billTypeFilter').value;
    const amountFilter = document.getElementById('amountFilter').value;
    const dateFromFilter = document.getElementById('dateFromFilter') ? document.getElementById('dateFromFilter').value : '';
    const dateToFilter = document.getElementById('dateToFilter') ? document.getElementById('dateToFilter').value : '';
    
    if (searchTerm) activeFilters.push(`Search: "${searchTerm}"`);
    if (statusFilter !== 'all') activeFilters.push(`Status: ${statusFilter}`);
    if (billTypeFilter !== 'all') activeFilters.push(`Type: ${billTypeFilter}`);
    if (amountFilter !== 'all') activeFilters.push(`Amount: ${amountFilter}`);
    if (dateFromFilter) activeFilters.push(`From: ${dateFromFilter}`);
    if (dateToFilter) activeFilters.push(`To: ${dateToFilter}`);
    
    const activeFiltersElement = document.getElementById('activeFilters');
    if (activeFiltersElement) {
        if (activeFilters.length > 0) {
            activeFiltersElement.innerHTML = ' ‚Ä¢ ' + activeFilters.map(f => 
                `<span class="badge bg-warning text-dark">${f}</span>`
            ).join(' ');
        } else {
            activeFiltersElement.innerHTML = '';
        }
    }
}

function applyFilters() {
    const billType = document.getElementById('billTypeFilter').value;
    const year = document.getElementById('yearFilter').value;
    
    // If it's just bill type filtering, do it client-side for better UX
    if (billType !== 'all' && year === '{{ current_year }}') {
        filterBills();
        return;
    }
    
    // For year changes, we need to reload from server
    const url = new URL(window.location);
    url.searchParams.set('bill_type', billType);
    url.searchParams.set('year', year);
    url.searchParams.delete('page');
    
    if (typeof showLoading === 'function') {
        showLoading('Applying filters...');
    }
    window.location.href = url.toString();
}

function clearAllFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = 'all';
    document.getElementById('billTypeFilter').value = 'all';
    document.getElementById('amountFilter').value = 'all';
    
    const dateFromFilter = document.getElementById('dateFromFilter');
    const dateToFilter = document.getElementById('dateToFilter');
    if (dateFromFilter) dateFromFilter.value = '';
    if (dateToFilter) dateToFilter.value = '';
    
    filterBills();
    
    // Show success message if SweetAlert is available
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'success',
            title: 'All filters cleared',
            showConfirmButton: false,
            timer: 2000
        });
    }
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('searchInput').focus();
    filterBills();
}

function toggleFilters() {
    const filtersBody = document.getElementById('filtersBody');
    const toggleBtn = document.getElementById('toggleFiltersBtn');
    
    if (filtersBody && toggleBtn) {
        if (filtersBody.style.display === 'none') {
            filtersBody.style.display = 'block';
            toggleBtn.innerHTML = '<i class="fas fa-chevron-up"></i> Collapse';
        } else {
            filtersBody.style.display = 'none';
            toggleBtn.innerHTML = '<i class="fas fa-chevron-down"></i> Expand';
        }
    }
}

function toggleAdvancedFilters() {
    const advancedFilters = document.getElementById('advancedFilters');
    const showAdvancedBtn = document.getElementById('showAdvancedBtn');
    
    if (advancedFilters && showAdvancedBtn) {
        if (advancedFilters.style.display === 'none') {
            advancedFilters.style.display = 'block';
            showAdvancedBtn.style.display = 'none';
        } else {
            advancedFilters.style.display = 'none';
            showAdvancedBtn.style.display = 'block';
        }
    }
}

function applySorting() {
    const sortBy = document.getElementById('sortBy').value;
    if (sortBy === 'default') {
        window.location.reload();
        return;
    }
    
    const table = document.getElementById('billsTable');
    if (!table) return;
    
    const tbody = table.getElementsByTagName('tbody')[0];
    const rows = Array.from(tbody.getElementsByTagName('tr'));
    
    rows.sort((a, b) => {
        let aValue, bValue;
        
        switch (sortBy) {
            case 'amount_desc':
            case 'amount_asc':
                aValue = parseFloat(a.getAttribute('data-amount')) || 0;
                bValue = parseFloat(b.getAttribute('data-amount')) || 0;
                break;
            case 'date_desc':
            case 'date_asc':
                aValue = new Date(a.getAttribute('data-generation-date'));
                bValue = new Date(b.getAttribute('data-generation-date'));
                break;
            case 'house_asc':
                aValue = a.cells[0].textContent.trim().toLowerCase();
                bValue = b.cells[0].textContent.trim().toLowerCase();
                break;
            default:
                return 0;
        }
        
        if (sortBy.includes('desc')) {
            return bValue > aValue ? 1 : (bValue < aValue ? -1 : 0);
        } else {
            return aValue > bValue ? 1 : (aValue < bValue ? -1 : 0);
        }
    });
    
    rows.forEach(row => tbody.appendChild(row));
}

// Enhanced export functionality
function exportBills() {
    if (typeof showLoading === 'function') {
        showLoading('Preparing export...');
    }
    
    const table = document.getElementById('billsTable');
    if (!table) return;
    
    const data = [];
    
    // Get headers (exclude actions column)
    const headers = [];
    const headerRow = table.querySelector('thead tr');
    for (let i = 0; i < headerRow.cells.length - 1; i++) {
        headers.push(headerRow.cells[i].textContent.replace(/\s+/g, ' ').trim());
    }
    data.push(headers);
    
    // Get visible rows data only
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
        if (row.style.display !== 'none') {
            const rowData = [];
            for (let i = 0; i < row.cells.length - 1; i++) {
                rowData.push(row.cells[i].textContent.replace(/\s+/g, ' ').trim());
            }
            data.push(rowData);
        }
    });
    
    // Create CSV content
    const csvContent = data.map(row => 
        row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(',')
    ).join('\n');
    
    // Download file
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `bills_filtered_export_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    if (typeof hideLoading === 'function') {
        hideLoading();
    }
    
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'success',
            title: 'Filtered bills exported successfully!',
            showConfirmButton: false,
            timer: 3000
        });
    }
}

// Enhanced bill details view
function viewBillDetails(billId) {
    const billRow = event.target.closest('tr');
    const cells = billRow.querySelectorAll('td');
    
    // Extract bill data from the row
    const isAdmin = {{ 'true' if user_role == 'admin' else 'false' }};
    const houseInfo = isAdmin ? cells[0].textContent.trim() : 'Your House';
    const billType = cells[isAdmin ? 1 : 0].textContent.trim();
    const billingCycle = cells[isAdmin ? 2 : 1].textContent.trim();
    const totalDue = cells[isAdmin ? 5 : 4].textContent.trim();
    const balance = cells[isAdmin ? 7 : 6].textContent.trim();
    const status = cells[isAdmin ? 8 : 7].textContent.trim();

    // Enhanced bill details modal
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            title: '<i class="fas fa-file-invoice-dollar"></i> Bill Details',
            html: `
                <div class="row text-start">
                    <div class="col-md-6">
                        <div class="card border-primary mb-3">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-info-circle"></i> Bill Information</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Bill ID:</strong> ${billId}</p>
                                ${isAdmin ? `<p><strong>House:</strong> ${houseInfo}</p>` : ''}
                                <p><strong>Bill Type:</strong> ${billType}</p>
                                <p><strong>Billing Cycle:</strong> ${billingCycle}</p>
                                <p><strong>Status:</strong> ${status}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-success mb-3">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-rupee-sign"></i> Amount Details</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Total Due:</strong> <span class="text-primary">${totalDue}</span></p>
                                <p><strong>Outstanding:</strong> <span class="text-danger">${balance}</span></p>
                                <p><strong>Due Date:</strong> ${cells[isAdmin ? 4 : 3].textContent.trim()}</p>
                                <p><strong>Generated:</strong> ${cells[isAdmin ? 3 : 2].textContent.trim()}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            width: 800,
            showCancelButton: true,
            confirmButtonText: '<i class="fas fa-print"></i> Print Bill',
            cancelButtonText: 'Close',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                printBill(billId);
            }
        });
    } else {
        // Fallback for when SweetAlert is not available
        alert(`Bill Details:\nBill ID: ${billId}\nHouse: ${houseInfo}\nType: ${billType}\nCycle: ${billingCycle}\nAmount: ${totalDue}`);
    }
}

function printBill(billId) {
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            title: 'Print Bill',
            text: 'This will open the bill in a new window for printing.',
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'Open Print View',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                openPrintView(billId);
            }
        });
    } else {
        if (confirm('Open print view for this bill?')) {
            openPrintView(billId);
        }
    }
}

function openPrintView(billId) {
    // In a real implementation, this would open a print-friendly bill view
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Bill #${billId}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; }
                .bill-details { margin: 20px 0; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #333; padding: 8px; text-align: left; }
                th { background-color: #f0f0f0; }
                .total { font-weight: bold; font-size: 1.2em; }
                @media print { 
                    .no-print { display: none; } 
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Community Management System</h1>
                <h2>Bill #${billId}</h2>
            </div>
            <div class="bill-details">
                <p><strong>Generated on:</strong> ${new Date().toLocaleDateString()}</p>
                <p><strong>Note:</strong> This is a demo print view. In the actual implementation, complete bill details would be displayed here.</p>
            </div>
            <div class="no-print" style="margin-top: 20px;">
                <button onclick="window.print()">Print</button>
                <button onclick="window.close()">Close</button>
            </div>
        </body>
        </html>
    `);
    printWindow.document.close();
}

// Quick payment functionality
function recordQuickPayment(billId) {
    const billRow = event.target.closest('tr');
    const isAdmin = {{ 'true' if user_role == 'admin' else 'false' }};
    const houseInfo = isAdmin ? billRow.cells[0].textContent.trim() : 'Your House';
    const billType = billRow.cells[isAdmin ? 1 : 0].textContent.trim();
    const billingCycle = billRow.cells[isAdmin ? 2 : 1].textContent.trim();
    const balance = billRow.cells[isAdmin ? 7 : 6].textContent.replace('‚Çπ', '').trim();
    
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            title: '<i class="fas fa-credit-card"></i> Record Quick Payment',
            html: `
                <div class="text-start">
                    <div class="alert alert-info">
                        <strong>Bill:</strong> ${houseInfo} - ${billType} - ${billingCycle}<br>
                        <strong>Outstanding:</strong> ‚Çπ${balance}
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="quickAmount" class="form-label">Amount Paid *</label>
                            <input type="number" step="0.01" class="form-control" id="quickAmount" 
                                   value="${balance}" min="0" max="${balance}">
                        </div>
                        <div class="col-md-6">
                            <label for="quickDate" class="form-label">Payment Date *</label>
                            <input type="date" class="form-control" id="quickDate" 
                                   value="${new Date().toISOString().split('T')[0]}">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="quickMethod" class="form-label">Payment Method</label>
                            <select class="form-select" id="quickMethod">
                                <option value="cash">Cash</option>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="upi">UPI</option>
                                <option value="cheque">Cheque</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="quickTxnId" class="form-label">Transaction ID</label>
                            <input type="text" class="form-control" id="quickTxnId" 
                                   placeholder="Optional">
                        </div>
                    </div>
                    <div class="mt-3">
                        <label for="quickNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="quickNotes" rows="2" 
                                  placeholder="Optional notes..."></textarea>
                    </div>
                </div>
            `,
            width: 600,
            showCancelButton: true,
            confirmButtonText: '<i class="fas fa-save"></i> Record Payment',
            cancelButtonText: 'Cancel',
            preConfirm: () => {
                const amount = document.getElementById('quickAmount').value;
                const date = document.getElementById('quickDate').value;
                
                if (!amount || !date) {
                    Swal.showValidationMessage('Please fill in all required fields');
                    return false;
                }
                
                if (parseFloat(amount) <= 0) {
                    Swal.showValidationMessage('Amount must be greater than 0');
                    return false;
                }
                
                if (parseFloat(amount) > parseFloat(balance)) {
                    Swal.showValidationMessage('Amount cannot exceed outstanding balance');
                    return false;
                }
                
                return {
                    amount: amount,
                    date: date,
                    method: document.getElementById('quickMethod').value,
                    txnId: document.getElementById('quickTxnId').value,
                    notes: document.getElementById('quickNotes').value
                };
            }
        }).then((result) => {
            if (result.isConfirmed) {
                if (typeof showLoading === 'function') {
                    showLoading('Recording payment...');
                }
                
                // In real implementation, this would submit to the server
                setTimeout(() => {
                    if (typeof hideLoading === 'function') {
                        hideLoading();
                    }
                    Swal.fire('Success!', 'Payment recorded successfully.', 'success');
                    // Refresh the page to show updated data
                    window.location.reload();
                }, 2000);
            }
        });
    } else {
        // Fallback for when SweetAlert is not available
        const amount = prompt(`Record payment for ‚Çπ${balance}?\nEnter amount:`);
        if (amount && parseFloat(amount) > 0) {
            alert('Payment would be recorded. In the actual implementation, this would submit to the server.');
        }
    }
}

// Table sorting functionality
function sortBillsTable(columnIndex) {
    const table = document.getElementById('billsTable');
    if (!table) return;
    
    const tbody = table.getElementsByTagName('tbody')[0];
    const rows = Array.from(tbody.getElementsByTagName('tr'));
    
    // Determine sort direction
    const currentSort = table.getAttribute('data-sort-column');
    const currentDirection = table.getAttribute('data-sort-direction') || 'asc';
    const newDirection = (currentSort == columnIndex && currentDirection === 'asc') ? 'desc' : 'asc';
    
    // Sort rows
    rows.sort((a, b) => {
        if (a.style.display === 'none' && b.style.display === 'none') return 0;
        if (a.style.display === 'none') return 1;
        if (b.style.display === 'none') return -1;
        
        let aValue = a.cells[columnIndex].textContent.trim();
        let bValue = b.cells[columnIndex].textContent.trim();
        
        // Handle currency values
        if (aValue.includes('‚Çπ')) {
            aValue = parseFloat(aValue.replace('‚Çπ', '').replace(',', ''));
            bValue = parseFloat(bValue.replace('‚Çπ', '').replace(',', ''));
        }
        
        // Handle dates
        if (aValue.match(/\d{4}-\d{2}-\d{2}/)) {
            aValue = new Date(aValue);
            bValue = new Date(bValue);
        }
        
        if (typeof aValue === 'number' && typeof bValue === 'number') {
            return newDirection === 'asc' ? aValue - bValue : bValue - aValue;
        } else if (aValue instanceof Date && bValue instanceof Date) {
            return newDirection === 'asc' ? aValue - bValue : bValue - aValue;
        } else {
            aValue = aValue.toString().toLowerCase();
            bValue = bValue.toString().toLowerCase();
            if (newDirection === 'asc') {
                return aValue.localeCompare(bValue);
            } else {
                return bValue.localeCompare(aValue);
            }
        }
    });
    
    // Update table
    rows.forEach(row => tbody.appendChild(row));
    
    // Update sort indicators
    table.setAttribute('data-sort-column', columnIndex);
    table.setAttribute('data-sort-direction', newDirection);
    
    // Update sort icons
    const headers = table.querySelectorAll('th i.fa-sort, th i.fa-sort-up, th i.fa-sort-down');
    headers.forEach(icon => {
        icon.className = 'fas fa-sort text-muted';
    });
    
    const currentHeader = table.querySelectorAll('th')[columnIndex].querySelector('i');
    if (currentHeader) {
        currentHeader.className = `fas fa-sort-${newDirection === 'asc' ? 'up' : 'down'} text-primary`;
    }
}

// Real-time search with debouncing
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    let searchTimeout;
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterBills, 300);
        });
        
        // Add search shortcut (Ctrl+F)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                searchInput.focus();
            }
        });
    }
    
    // Initialize filters
    filterBills();
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey) {
            switch(e.key) {
                case 'e':
                    e.preventDefault();
                    exportBills();
                    break;
                case 'r':
                    e.preventDefault();
                    clearAllFilters();
                    break;
            }
        }
    });
    
    // Initialize tooltips if Bootstrap is available
    if (typeof bootstrap !== 'undefined') {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
});

// Copy to clipboard functionality
function copyToClipboard(text, successMessage = 'Copied to clipboard!') {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: successMessage,
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        });
    } else {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: successMessage,
                showConfirmButton: false,
                timer: 2000
            });
        }
    }
}
</script>
{% endblock %}