<!-- templates/meter_readings.html -->
{% extends "base.html" %}

{% block title %}Meter Readings - Community Management{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page">
    <i class="fas fa-tint"></i> Meter Readings
</li>
{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1><i class="fas fa-tint"></i> {{ 'Meter Readings Management' if user_role == 'admin' else 'My Meter Readings' }}</h1>
        <p>{{ 'Manage water meter readings for all houses' if user_role == 'admin' else 'View your water meter reading history' }}
            <i class="fas fa-question-circle help-icon" 
               data-bs-toggle="tooltip" 
               title="Meter readings are used to calculate water consumption and billing"></i>
        </p>
    </div>
    <div>
        <button class="btn btn-outline-success me-2" id="exportButton" data-bs-toggle="tooltip" title="Export readings to Excel">
            <i class="fas fa-file-excel"></i> Export
        </button>
        {% if user_role == 'admin' %}
        <a href="{{ url_for('add_meter_reading') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Add Reading
        </a>
        {% endif %}
    </div>
</div>

<!-- Enhanced Quick Stats with Consumption Insights -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="quick-stats">
            <h6>Total Readings</h6>
            <div class="stat-value">{{ pagination.total if pagination else 0 }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="quick-stats success">
            <h6>This Period</h6>
            <div class="stat-value">{{ readings|length if readings else 0 }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="quick-stats warning">
            <h6>Total Consumption</h6>
            <div class="stat-value">{{ "%.0f"|format(readings|sum(attribute='consumption') if readings else 0) }}</div>
            <small>units</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="quick-stats info">
            <h6>Average/House</h6>
            <div class="stat-value">
                {% if readings %}
                    {% set total_consumption = readings|sum(attribute='consumption') or 0 %}
                    {% set house_count = readings|groupby('house_number')|list|length %}
                    {{ "%.1f"|format((total_consumption / house_count) if house_count > 0 else 0) }}
                {% else %}
                    0.0
                {% endif %}
            </div>
            <small>units</small>
        </div>
    </div>
</div>

<!-- Enhanced Filter Section -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" 
                           placeholder="Search by house number or owner..." onkeyup="filterReadings()">
                </div>
            </div>
            <div class="col-md-2">
                <label for="yearFilter" class="form-label">Year:</label>
                <select class="form-select" id="yearFilter" onchange="applyFilters()">
                    <option value="all" {% if current_year == 'all' %}selected{% endif %}>All Years</option>
                    {% for year in available_years %}
                    <option value="{{ year.year }}" {% if current_year == year.year|string %}selected{% endif %}>{{ year.year }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="statusFilterSelect" class="form-label">Status:</label>
                <select class="form-select" id="statusFilterSelect" onchange="filterReadings()">
                    <option value="all">All Status</option>
                    <option value="verified">Verified</option>
                    <option value="pending_verification">Pending</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="consumptionFilter" class="form-label">Consumption:</label>
                <select class="form-select" id="consumptionFilter" onchange="filterReadings()">
                    <option value="all">All Ranges</option>
                    <option value="high">High (>30 units)</option>
                    <option value="medium">Medium (10-30 units)</option>
                    <option value="low">Low (<10 units)</option>
                    <option value="zero">Zero consumption</option>
                </select>
            </div>
            <div class="col-md-2 text-end">
                <button class="btn btn-outline-secondary" onclick="clearAllFilters()" data-bs-toggle="tooltip" title="Clear all filters">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
        </div>
        
        <!-- Filter summary -->
        <div class="row mt-3">
            <div class="col-12">
                <small class="text-muted">
                    <i class="fas fa-info-circle"></i>
                    Showing <span id="visibleCount">{{ readings|length if readings else 0 }}</span> of {{ pagination.total if pagination else 0 }} readings
                    • Total consumption: <span id="visibleConsumption">{{ "%.1f"|format(readings|sum(attribute='consumption') if readings else 0) }}</span> units
                    {% if current_year and current_year != 'all' %}• Year: {{ current_year }}{% endif %}
                </small>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        {% if readings and readings|length > 0 %}
        <div class="table-responsive">
            <table class="table" id="readingsTable">
                <thead>
                    <tr>
                        {% if user_role == 'admin' %}
                        <th onclick="sortReadingsTable(0)" style="cursor: pointer;">
                            House <i class="fas fa-sort text-muted"></i>
                        </th>
                        <th onclick="sortReadingsTable(1)" style="cursor: pointer;">
                            Owner <i class="fas fa-sort text-muted"></i>
                        </th>
                        {% endif %}
                        <th onclick="sortReadingsTable({{ '2' if user_role == 'admin' else '0' }})" style="cursor: pointer;">
                            Reading Date <i class="fas fa-sort text-muted"></i>
                        </th>
                        <th>Previous Reading</th>
                        <th>Current Reading 
                            <i class="fas fa-question-circle help-icon" 
                               data-bs-toggle="tooltip" 
                               title="Current meter reading in units"></i>
                        </th>
                        <th onclick="sortReadingsTable({{ '5' if user_role == 'admin' else '3' }})" style="cursor: pointer;">
                            Consumption <i class="fas fa-sort text-muted"></i>
                        </th>
                        <th>Status</th>
                        {% if user_role == 'admin' %}
                        <th>Actions</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for reading in readings %}
                    <tr data-status="{{ reading.status }}" 
                        data-consumption="{{ reading.consumption or 0 }}"
                        data-reading-id="{{ reading.id }}"
                        data-house-number="{{ reading.house_number if user_role == 'admin' else '' }}"
                        data-owner-name="{{ reading.owner_name if user_role == 'admin' else '' }}"
                        data-reading-date="{{ reading.reading_date }}"
                        data-current-reading="{{ reading.current_reading }}"
                        data-previous-reading="{{ reading.previous_reading or 0 }}"
                        data-consumption-value="{{ reading.consumption or 0 }}"
                        data-reading-status="{{ reading.status }}">
                        {% if user_role == 'admin' %}
                        <td><strong>{{ reading.house_number }}</strong></td>
                        <td>{{ reading.owner_name }}</td>
                        {% endif %}
                        <td>
                            {{ reading.reading_date }}
                            <i class="fas fa-copy text-muted ms-1" style="cursor: pointer;" 
                               onclick="copyToClipboard('{{ reading.reading_date }}')" 
                               data-bs-toggle="tooltip" title="Copy date"></i>
                        </td>
                        <td>
                            <span class="text-muted">{{ "%.2f"|format(reading.previous_reading or 0) }}</span>
                        </td>
                        <td>
                            <strong>{{ "%.2f"|format(reading.current_reading) }}</strong>
                            <i class="fas fa-copy text-muted ms-1" style="cursor: pointer;" 
                               onclick="copyToClipboard('{{ reading.current_reading }}')" 
                               data-bs-toggle="tooltip" title="Copy reading"></i>
                        </td>
                        <td>
                            {% if reading.consumption and reading.consumption > 0 %}
                                {% set consumption_class = 'success' if reading.consumption <= 20 else 'warning' if reading.consumption <= 40 else 'danger' %}
                                <span class="badge bg-{{ consumption_class }}">
                                    <i class="fas fa-tint"></i> {{ "%.2f"|format(reading.consumption) }} units
                                </span>
                                {% if reading.consumption > 40 %}
                                    <i class="fas fa-exclamation-triangle text-warning ms-1" 
                                       data-bs-toggle="tooltip" title="High consumption - please verify"></i>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-secondary">
                                    <i class="fas fa-minus"></i> 0.00 units
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if reading.status == 'verified' %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check-circle"></i> Verified
                                </span>
                            {% elif reading.status == 'pending_verification' %}
                                <span class="badge bg-warning">
                                    <i class="fas fa-clock"></i> Pending
                                </span>
                            {% else %}
                                <span class="badge bg-info">
                                    <i class="fas fa-info-circle"></i> {{ reading.status.title() }}
                                </span>
                            {% endif %}
                        </td>
                        {% if user_role == 'admin' %}
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-info" onclick="viewReadingDetails(this)"
                                        data-bs-toggle="tooltip" title="View reading details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="editReading(this)"
                                        data-bs-toggle="tooltip" title="Edit reading">
                                    <i class="fas fa-edit"></i>
                                </button>
                                {% if reading.status != 'verified' %}
                                <button class="btn btn-sm btn-outline-success" onclick="verifyReading({{ reading.id }})"
                                        data-bs-toggle="tooltip" title="Mark as verified">
                                    <i class="fas fa-check"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        {% if user_role == 'admin' %}
                        <th colspan="2">TOTALS</th>
                        {% else %}
                        <th>TOTALS</th>
                        {% endif %}
                        <th><span class="badge bg-info">{{ readings|length }} readings</span></th>
                        <th>-</th>
                        <th>-</th>
                        <th>
                            <strong class="text-primary">
                                <i class="fas fa-tint"></i> {{ "%.2f"|format(readings|sum(attribute='consumption') or 0) }} units
                            </strong>
                        </th>
                        <th>-</th>
                        {% if user_role == 'admin' %}
                        <th>-</th>
                        {% endif %}
                    </tr>
                </tfoot>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-tint fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No Meter Readings Found</h4>
            <div class="alert alert-warning mt-3">
                <h6><i class="fas fa-info-circle"></i> Possible Reasons:</h6>
                <ul class="mb-0 text-start">
                    <li>No meter readings have been recorded yet</li>
                    <li>Selected year filter has no data</li>
                    <li>User has no house assigned (for residents)</li>
                    <li>Database connection issue</li>
                </ul>
            </div>
            <p class="text-muted">
                {% if user_role == 'admin' %}
                    <a href="{{ url_for('add_meter_reading') }}" class="btn btn-primary mt-2">
                        <i class="fas fa-plus"></i> Add First Reading
                    </a>
                    <button class="btn btn-outline-info mt-2 ms-2" onclick="showDebuggingInfo()">
                        <i class="fas fa-bug"></i> Debug Info
                    </button>
                {% else %}
                    Please contact administrator if this seems incorrect.
                    <br>
                    <button class="btn btn-outline-info mt-2" onclick="showContactInfo()">
                        <i class="fas fa-phone"></i> Contact Admin
                    </button>
                {% endif %}
            </p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Enhanced Pagination -->
{% if pagination.pages > 1 %}
<div class="d-flex justify-content-between align-items-center mt-4">
    <div>
        <small class="text-muted">
            <i class="fas fa-info-circle"></i>
            Showing {{ ((pagination.page - 1) * pagination.per_page + 1) }} to 
            {{ (pagination.page * pagination.per_page) if pagination.page < pagination.pages else pagination.total }} 
            of {{ pagination.total }} records
        </small>
    </div>
    <nav>
        <ul class="pagination">
            {% if pagination.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('meter_readings', year=current_year, page=pagination.prev_num) }}">
                    <i class="fas fa-chevron-left"></i> Previous
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link"><i class="fas fa-chevron-left"></i> Previous</span>
            </li>
            {% endif %}
            
            {% for page_num in range(1, pagination.pages + 1) %}
                {% if page_num == pagination.page %}
                <li class="page-item active">
                    <span class="page-link">{{ page_num }}</span>
                </li>
                {% elif page_num == 1 or page_num == pagination.pages or (page_num >= pagination.page - 2 and page_num <= pagination.page + 2) %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('meter_readings', year=current_year, page=page_num) }}">{{ page_num }}</a>
                </li>
                {% elif page_num == pagination.page - 3 or page_num == pagination.page + 3 %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
                {% endif %}
            {% endfor %}
            
            {% if pagination.has_next %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('meter_readings', year=current_year, page=pagination.next_num) }}">
                    Next <i class="fas fa-chevron-right"></i>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">Next <i class="fas fa-chevron-right"></i></span>
            </li>
            {% endif %}
        </ul>
    </nav>
</div>
{% endif %}

<!-- Enhanced Reading Details Modal -->
<div class="modal fade" id="readingDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-tint"></i> Meter Reading Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="readingDetailsContent">
                <!-- Reading details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" onclick="printReadingDetails()">
                    <i class="fas fa-print"></i> Print
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Edit Reading Modal -->
<div class="modal fade" id="editReadingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Meter Reading</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editReadingForm" data-no-loading="true">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Editing reading for <strong id="editReadingHouseInfo"></strong>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editCurrentReading" class="form-label">
                                    Current Reading *
                                    <i class="fas fa-question-circle help-icon" 
                                       data-bs-toggle="tooltip" 
                                       title="Enter the current meter reading value"></i>
                                </label>
                                <div class="input-group">
                                    <input type="number" step="0.01" class="form-control" id="editCurrentReading" required min="0">
                                    <span class="input-group-text">units</span>
                                </div>
                                <small class="form-text text-muted">Previous: <span id="editPreviousReading">0.00</span> units</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editReadingDate" class="form-label">Reading Date *</label>
                                <input type="date" class="form-control" id="editReadingDate" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editStatus" class="form-label">Status</label>
                                <select class="form-select" id="editStatus">
                                    <option value="verified">✓ Verified</option>
                                    <option value="pending_verification">⏳ Pending Verification</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Calculated Consumption</label>
                                <div class="form-control-plaintext">
                                    <strong id="calculatedConsumption">0.00 units</strong>
                                    <small class="text-muted d-block">Auto-calculated from readings</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Enhanced filtering functionality
function filterReadings() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilterSelect').value;
    const consumptionFilter = document.getElementById('consumptionFilter').value;
    const table = document.getElementById('readingsTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    let visibleCount = 0;
    let visibleConsumption = 0;

    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        let searchMatch = true;
        let statusMatch = true;
        let consumptionMatch = true;

        // Search match
        if (searchTerm) {
            const rowText = row.textContent.toLowerCase();
            searchMatch = rowText.includes(searchTerm);
        }

        // Status match
        if (statusFilter !== 'all') {
            const rowStatus = row.getAttribute('data-status');
            statusMatch = rowStatus === statusFilter;
        }

        // Consumption match
        if (consumptionFilter !== 'all') {
            const consumption = parseFloat(row.getAttribute('data-consumption')) || 0;
            switch (consumptionFilter) {
                case 'high':
                    consumptionMatch = consumption > 30;
                    break;
                case 'medium':
                    consumptionMatch = consumption >= 10 && consumption <= 30;
                    break;
                case 'low':
                    consumptionMatch = consumption > 0 && consumption < 10;
                    break;
                case 'zero':
                    consumptionMatch = consumption === 0;
                    break;
            }
        }

        if (searchMatch && statusMatch && consumptionMatch) {
            row.style.display = '';
            visibleCount++;
            visibleConsumption += parseFloat(row.getAttribute('data-consumption')) || 0;
        } else {
            row.style.display = 'none';
        }
    }

    document.getElementById('visibleCount').textContent = visibleCount;
    document.getElementById('visibleConsumption').textContent = visibleConsumption.toFixed(1);
}

function applyFilters() {
    const year = document.getElementById('yearFilter').value;
    const url = new URL(window.location);
    url.searchParams.set('year', year);
    url.searchParams.delete('page');
    
    showLoading('Applying filters...');
    window.location.href = url.toString();
}

function clearAllFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilterSelect').value = 'all';
    document.getElementById('consumptionFilter').value = 'all';
    filterReadings();
}

// FIXED: Enhanced reading details view with proper data extraction
function viewReadingDetails(buttonElement) {
    // Get the row containing the clicked button
    const row = buttonElement.closest('tr');
    
    // Extract data from the row's data attributes
    const readingId = row.getAttribute('data-reading-id');
    const houseNumber = row.getAttribute('data-house-number') || 'Your House';
    const ownerName = row.getAttribute('data-owner-name') || '';
    const readingDate = row.getAttribute('data-reading-date');
    const currentReading = parseFloat(row.getAttribute('data-current-reading')) || 0;
    const previousReading = parseFloat(row.getAttribute('data-previous-reading')) || 0;
    const consumption = parseFloat(row.getAttribute('data-consumption-value')) || 0;
    const status = row.getAttribute('data-reading-status') || 'unknown';
    
    // Check if we have valid data
    if (!readingId || !readingDate) {
        Swal.fire('Error', 'Unable to load reading details. Please try again.', 'error');
        return;
    }

    // Build the modal content
    const isAdmin = {{ 'true' if user_role == 'admin' else 'false' }};
    
    document.getElementById('readingDetailsContent').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="fas fa-info-circle"></i> Reading Information</h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Reading ID:</strong> ${readingId}</p>
                        ${isAdmin && houseNumber !== 'Your House' ? `<p><strong>House:</strong> ${houseNumber}</p>` : ''}
                        ${isAdmin && ownerName ? `<p><strong>Owner:</strong> ${ownerName}</p>` : ''}
                        <p><strong>Reading Date:</strong> ${formatDate(readingDate)}</p>
                        <p><strong>Status:</strong> ${getStatusBadge(status)}</p>
                        <p><strong>Reading Type:</strong> <span class="badge bg-secondary">L&T Individual</span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="fas fa-tachometer-alt"></i> Consumption Details</h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Previous Reading:</strong> ${previousReading.toFixed(2)} units</p>
                        <p><strong>Current Reading:</strong> <span class="text-primary">${currentReading.toFixed(2)} units</span></p>
                        <p><strong>Consumption:</strong> ${getConsumptionDisplay(consumption)}</p>
                        <p><strong>Estimated Cost:</strong> <span class="text-success">₹${(consumption * 70).toFixed(2)}</span></p>
                        <small class="text-muted">* Based on ₹70 per unit rate</small>
                    </div>
                </div>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-12">
                <h6><i class="fas fa-chart-line"></i> Consumption Analysis</h6>
                <div class="alert alert-light">
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Consumption Level:</strong> 
                            ${getConsumptionLevel(consumption)}
                        </div>
                        <div class="col-md-4">
                            <strong>Daily Average:</strong> 
                            ${(consumption / 30).toFixed(2)} units/day
                        </div>
                        <div class="col-md-4">
                            <strong>Submitted:</strong> ${formatDate(readingDate)}
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <small class="text-muted">
                                <i class="fas fa-lightbulb"></i> ${getConsumptionAdvice(consumption)}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('readingDetailsModal'));
    modal.show();
}

// Helper functions for the modal
function getStatusBadge(status) {
    switch(status) {
        case 'verified':
            return '<span class="badge bg-success"><i class="fas fa-check-circle"></i> Verified</span>';
        case 'pending_verification':
            return '<span class="badge bg-warning"><i class="fas fa-clock"></i> Pending</span>';
        default:
            return '<span class="badge bg-info"><i class="fas fa-info-circle"></i> ' + status.charAt(0).toUpperCase() + status.slice(1) + '</span>';
    }
}

function getConsumptionDisplay(consumption) {
    if (consumption === 0) {
        return '<span class="badge bg-secondary"><i class="fas fa-minus"></i> 0.00 units</span>';
    } else if (consumption <= 20) {
        return '<span class="badge bg-success"><i class="fas fa-tint"></i> ' + consumption.toFixed(2) + ' units</span>';
    } else if (consumption <= 40) {
        return '<span class="badge bg-warning"><i class="fas fa-tint"></i> ' + consumption.toFixed(2) + ' units</span>';
    } else {
        return '<span class="badge bg-danger"><i class="fas fa-tint"></i> ' + consumption.toFixed(2) + ' units</span>';
    }
}

function getConsumptionLevel(consumption) {
    if (consumption === 0) return '<span class="badge bg-secondary">No Consumption</span>';
    if (consumption < 10) return '<span class="badge bg-success">Low</span>';
    if (consumption <= 30) return '<span class="badge bg-warning">Normal</span>';
    return '<span class="badge bg-danger">High</span>';
}

function getConsumptionAdvice(consumption) {
    if (consumption === 0) {
        return 'Zero consumption detected. Please verify meter reading is correct.';
    } else if (consumption < 10) {
        return 'Excellent! Low water usage is environmentally friendly and cost-effective.';
    } else if (consumption <= 30) {
        return 'Normal consumption range for a typical household.';
    } else if (consumption <= 50) {
        return 'High consumption detected. Consider checking for leaks or reducing usage.';
    } else {
        return 'Very high consumption! Please verify reading and check for leaks immediately.';
    }
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-IN', {
        year: 'numeric',
        month: 'short',
        day: '2-digit'
    });
}

// FIXED: Enhanced edit reading functionality
function editReading(buttonElement) {
    // Get the row containing the clicked button
    const row = buttonElement.closest('tr');
    
    // Extract data from the row's data attributes
    const readingId = row.getAttribute('data-reading-id');
    const houseNumber = row.getAttribute('data-house-number') || '';
    const ownerName = row.getAttribute('data-owner-name') || '';
    const currentReading = parseFloat(row.getAttribute('data-current-reading')) || 0;
    const previousReading = parseFloat(row.getAttribute('data-previous-reading')) || 0;
    const readingDate = row.getAttribute('data-reading-date');
    const status = row.getAttribute('data-reading-status') || 'verified';
    
    // Check if we have valid data
    if (!readingId || !readingDate) {
        Swal.fire('Error', 'Unable to load reading details for editing. Please try again.', 'error');
        return;
    }
    
    const isAdmin = {{ 'true' if user_role == 'admin' else 'false' }};
    const houseInfo = isAdmin ? `${houseNumber} - ${ownerName}` : 'Your House';
    
    // Populate the edit modal
    document.getElementById('editReadingHouseInfo').textContent = houseInfo;
    document.getElementById('editCurrentReading').value = currentReading.toFixed(2);
    document.getElementById('editPreviousReading').textContent = previousReading.toFixed(2);
    document.getElementById('editReadingDate').value = readingDate;
    document.getElementById('editStatus').value = status;
    
    // Calculate and show consumption
    updateCalculatedConsumption();
    
    // Store reading ID for saving
    document.getElementById('editReadingForm').dataset.readingId = readingId;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('editReadingModal'));
    modal.show();
}

function updateCalculatedConsumption() {
    const current = parseFloat(document.getElementById('editCurrentReading').value) || 0;
    const previous = parseFloat(document.getElementById('editPreviousReading').textContent) || 0;
    const consumption = Math.max(0, current - previous);
    
    document.getElementById('calculatedConsumption').textContent = `${consumption.toFixed(2)} units`;
    
    // Add visual feedback for consumption level
    const consumptionElement = document.getElementById('calculatedConsumption');
    consumptionElement.className = '';
    if (consumption === 0) {
        consumptionElement.className = 'text-muted';
    } else if (consumption < 10) {
        consumptionElement.className = 'text-success';
    } else if (consumption <= 30) {
        consumptionElement.className = 'text-warning';
    } else {
        consumptionElement.className = 'text-danger';
    }
}

// Quick verify reading function
async function verifyReading(readingId) {
    const result = await confirmAction(
        'Verify Reading?',
        'Mark this meter reading as verified?',
        'question',
        'Yes, Verify',
        'Cancel'
    );
    
    if (result.isConfirmed) {
        showLoading('Verifying reading...');
        
        // In real implementation, this would make an AJAX call
        setTimeout(() => {
            hideLoading();
            Swal.fire('Verified!', 'Meter reading has been verified.', 'success');
            window.location.reload();
        }, 1000);
    }
}

// Handle edit form submission
document.addEventListener('DOMContentLoaded', function() {
    const editForm = document.getElementById('editReadingForm');
    const currentReadingInput = document.getElementById('editCurrentReading');
    
    if (currentReadingInput) {
        currentReadingInput.addEventListener('input', updateCalculatedConsumption);
    }
    
    if (editForm) {
        editForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const readingId = this.dataset.readingId;
            const currentReading = document.getElementById('editCurrentReading').value;
            const readingDate = document.getElementById('editReadingDate').value;
            const status = document.getElementById('editStatus').value;
            
            if (!currentReading || !readingDate) {
                Swal.fire('Error', 'Please fill in all required fields.', 'error');
                return;
            }
            
            const result = await confirmAction(
                'Save Changes?',
                'Update this meter reading with the new values?',
                'question',
                'Yes, Save',
                'Cancel'
            );
            
            if (result.isConfirmed) {
                showLoading('Saving changes...');
                
                // In real implementation, this would submit to server
                setTimeout(() => {
                    hideLoading();
                    Swal.fire('Success!', 'Meter reading updated successfully.', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editReadingModal')).hide();
                    window.location.reload();
                }, 1500);
            }
        });
    }
});

// Table sorting functionality
function sortReadingsTable(columnIndex) {
    const table = document.getElementById('readingsTable');
    const tbody = table.getElementsByTagName('tbody')[0];
    const rows = Array.from(tbody.getElementsByTagName('tr'));
    
    const currentSort = table.getAttribute('data-sort-column');
    const currentDirection = table.getAttribute('data-sort-direction') || 'asc';
    const newDirection = (currentSort == columnIndex && currentDirection === 'asc') ? 'desc' : 'asc';
    
    rows.sort((a, b) => {
        let aValue = a.cells[columnIndex].textContent.trim();
        let bValue = b.cells[columnIndex].textContent.trim();
        
        // Handle dates
        if (aValue.match(/\d{4}-\d{2}-\d{2}/)) {
            aValue = new Date(aValue);
            bValue = new Date(bValue);
        }
        // Handle numbers (consumption, readings)
        else if (!isNaN(parseFloat(aValue))) {
            aValue = parseFloat(aValue);
            bValue = parseFloat(bValue);
        }
        // Handle text
        else {
            aValue = aValue.toLowerCase();
            bValue = bValue.toLowerCase();
        }
        
        if (typeof aValue === 'number' && typeof bValue === 'number') {
            return newDirection === 'asc' ? aValue - bValue : bValue - aValue;
        } else if (aValue instanceof Date && bValue instanceof Date) {
            return newDirection === 'asc' ? aValue - bValue : bValue - aValue;
        } else {
            if (newDirection === 'asc') {
                return aValue.toString().localeCompare(bValue.toString());
            } else {
                return bValue.toString().localeCompare(aValue.toString());
            }
        }
    });
    
    rows.forEach(row => tbody.appendChild(row));
    
    table.setAttribute('data-sort-column', columnIndex);
    table.setAttribute('data-sort-direction', newDirection);
    
    // Update sort icons
    const headers = table.querySelectorAll('th i.fa-sort, th i.fa-sort-up, th i.fa-sort-down');
    headers.forEach(icon => {
        icon.className = 'fas fa-sort text-muted';
    });
    
    const currentHeader = table.querySelectorAll('th')[columnIndex].querySelector('i');
    if (currentHeader) {
        currentHeader.className = `fas fa-sort-${newDirection === 'asc' ? 'up' : 'down'} text-primary`;
    }
}

// Export functionality - Simplified and more reliable version
function exportReadings() {
    console.log('exportReadings function called'); // Debug log
    
    showLoading('Preparing export...');
    
    try {
        const table = document.getElementById('readingsTable');
        if (!table) {
            console.error('Table not found');
            hideLoading();
            Swal.fire('Error', 'Table not found. Please refresh the page and try again.', 'error');
            return;
        }
        
        console.log('Table found, processing data...'); // Debug log
        
        // Get all table data
        const rows = table.querySelectorAll('tr');
        if (rows.length <= 1) {
            hideLoading();
            Swal.fire('No Data', 'No data available to export.', 'warning');
            return;
        }
        
        const csvData = [];
        let exportedRows = 0;
        
        // Process each row
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const cells = row.querySelectorAll('th, td');
            
            // Skip header row if it's from thead, or skip hidden rows
            if (i > 0 && row.style.display === 'none') {
                continue; // Skip hidden rows (filtered out)
            }
            
            const rowData = [];
            
            // Process each cell, but skip the last column if it contains "Actions"
            for (let j = 0; j < cells.length; j++) {
                const cellText = cells[j].textContent || '';
                
                // Skip Actions column
                if (cellText.toLowerCase().includes('action') || 
                    (j === cells.length - 1 && cellText.includes('fas fa-eye'))) {
                    continue;
                }
                
                // Clean up the text
                let cleanText = cellText
                    .replace(/\s+/g, ' ')  // Replace multiple spaces with single space
                    .replace(/[📋🔍📊⚡]/g, '') // Remove emoji icons
                    .replace(/\u25B2|\u25BC|\u25B6|\u25C0/g, '') // Remove sort arrows
                    .trim();
                
                rowData.push(cleanText);
            }
            
            if (rowData.length > 0) {
                csvData.push(rowData);
                if (i > 0) exportedRows++; // Don't count header row
            }
        }
        
        console.log(`Processed ${exportedRows} rows for export`); // Debug log
        
        if (exportedRows === 0) {
            hideLoading();
            Swal.fire('No Data', 'No rows available to export. Check your filters.', 'warning');
            return;
        }
        
        // Convert to CSV format
        const csvContent = csvData.map(row => 
            row.map(cell => {
                // Escape quotes and wrap in quotes if needed
                const str = String(cell || '');
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                return str;
            }).join(',')
        ).join('\n');
        
        console.log('CSV content created, initiating download...'); // Debug log
        
        // Create and download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        const now = new Date();
        const timestamp = now.getFullYear() + '-' + 
                         String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                         String(now.getDate()).padStart(2, '0');
        const filename = `meter_readings_${timestamp}.csv`;
        
        link.href = url;
        link.download = filename;
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Cleanup
        setTimeout(() => URL.revokeObjectURL(url), 100);
        
        hideLoading();
        
        console.log('Export completed successfully'); // Debug log
        
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'success',
            title: `Exported ${exportedRows} readings successfully!`,
            showConfirmButton: false,
            timer: 3000
        });
        
    } catch (error) {
        console.error('Export error:', error);
        hideLoading();
        
        Swal.fire({
            title: 'Export Failed',
            text: 'An error occurred while exporting. Please check the console for details and try again.',
            icon: 'error',
            footer: 'If the problem persists, please contact support.'
        });
    }
}

function printReadingDetails() {
    window.print();
}

// Real-time search with debouncing and event listeners setup
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    let searchTimeout;
    
    // Setup search functionality
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterReadings, 300);
        });
    }
    
    // Setup export button event listener
    const exportButton = document.getElementById('exportButton');
    if (exportButton) {
        exportButton.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Export button clicked'); // Debug log
            exportReadings();
        });
    }
    
    // Setup other event listeners
    const currentReadingInput = document.getElementById('editCurrentReading');
    if (currentReadingInput) {
        currentReadingInput.addEventListener('input', updateCalculatedConsumption);
    }
    
    const editForm = document.getElementById('editReadingForm');
    if (editForm) {
        editForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const readingId = this.dataset.readingId;
            const currentReading = document.getElementById('editCurrentReading').value;
            const readingDate = document.getElementById('editReadingDate').value;
            const status = document.getElementById('editStatus').value;
            
            if (!currentReading || !readingDate) {
                Swal.fire('Error', 'Please fill in all required fields.', 'error');
                return;
            }
            
            const result = await confirmAction(
                'Save Changes?',
                'Update this meter reading with the new values?',
                'question',
                'Yes, Save',
                'Cancel'
            );
            
            if (result.isConfirmed) {
                showLoading('Saving changes...');
                
                // In real implementation, this would submit to server
                setTimeout(() => {
                    hideLoading();
                    Swal.fire('Success!', 'Meter reading updated successfully.', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editReadingModal')).hide();
                    window.location.reload();
                }, 1500);
            }
        });
    }
    
    // Initialize filter on page load
    filterReadings();
    
    console.log('Event listeners initialized'); // Debug log
});

// Debug functions
function showDebuggingInfo() {
    Swal.fire({
        title: 'Debugging Information',
        html: `
            <div class="text-start">
                <h6><i class="fas fa-database"></i> Database Check:</h6>
                <p><strong>Current URL:</strong> ${window.location.href}</p>
                <p><strong>Current Year Filter:</strong> {{ current_year or 'Not set' }}</p>
                <p><strong>Available Years:</strong> {{ available_years|length if available_years else 0 }}</p>
                <hr>
                <h6><i class="fas fa-info-circle"></i> Suggestions:</h6>
                <ul>
                    <li>Try changing the year filter to "All Years"</li>
                    <li>Add some test meter readings first</li>
                    <li>Check if houses are properly set up</li>
                    <li>Verify database connectivity</li>
                </ul>
            </div>
        `,
        icon: 'info',
        confirmButtonText: 'Add Test Reading',
        showCancelButton: true,
        cancelButtonText: 'Close'
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = "{{ url_for('add_meter_reading') }}";
        }
    });
}

function showContactInfo() {
    Swal.fire({
        title: 'Contact Administrator',
        html: `
            <div class="text-start">
                <p><strong><i class="fas fa-envelope"></i> Email:</strong> admin@community.com</p>
                <p><strong><i class="fas fa-phone"></i> Phone:</strong> +91 98765 43210</p>
                <p><strong><i class="fas fa-clock"></i> Office Hours:</strong> 9:00 AM - 6:00 PM</p>
                <hr>
                <p class="text-muted small">Please mention that you're not seeing meter readings data.</p>
            </div>
        `,
        icon: 'info',
        confirmButtonText: 'Copy Email',
        showCancelButton: true,
        cancelButtonText: 'Close'
    }).then((result) => {
        if (result.isConfirmed) {
            copyToClipboard('admin@community.com', 'Admin email copied!');
        }
    });
}

// Show loading overlay
        function showLoading(message = 'Processing...') {
            const overlay = document.getElementById('loadingOverlay');
            const text = overlay.querySelector('p');
            text.textContent = message;
            overlay.style.display = 'flex';
        }
// Hide loading overlay
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
                
</script>
{% endblock %}