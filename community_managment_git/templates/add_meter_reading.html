<!-- templates/add_meter_reading.html -->
{% extends "base.html" %}

{% block title %}Add Meter Reading - Community Management{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{{ url_for('meter_readings') }}"><i class="fas fa-tint"></i> Meter Readings</a>
</li>
<li class="breadcrumb-item active" aria-current="page">Add Reading</li>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-tint"></i> Add Meter Reading</h1>
    <p>Record water meter reading for a house
        <i class="fas fa-question-circle help-icon" 
           data-bs-toggle="tooltip" 
           title="Meter readings are used to calculate water consumption and billing. Ensure accuracy."></i>
    </p>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-tachometer-alt"></i> Meter Reading Entry</h5>
            </div>
            <div class="card-body">
                <form method="POST" id="meterReadingForm">
                    <div class="mb-3">
                        <label for="house_id" class="form-label">
                            Select House *
                            <i class="fas fa-question-circle help-icon" 
                               data-bs-toggle="tooltip" 
                               title="Choose the house for which you want to record the meter reading"></i>
                        </label>
                        <select class="form-select" id="house_id" name="house_id" required onchange="loadHouseInfo()">
                            <option value="">Choose a house...</option>
                            {% for house in houses %}
                            <option value="{{ house.id }}" data-house-number="{{ house.house_number }}" data-owner="{{ house.owner_name }}">
                                {{ house.house_number }} - {{ house.owner_name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">
                            Please select a house.
                        </div>
                    </div>
                    
                    <!-- House Information Display -->
                    <div id="houseInfoCard" class="alert alert-info" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-home"></i> House Information</h6>
                                <p class="mb-1"><strong>House:</strong> <span id="selectedHouse">-</span></p>
                                <p class="mb-0"><strong>Owner:</strong> <span id="selectedOwner">-</span></p>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-history"></i> Previous Reading</h6>
                                <p class="mb-1"><strong>Last Reading:</strong> <span id="lastReading">No previous readings</span></p>
                                <p class="mb-0"><strong>Date:</strong> <span id="lastReadingDate">-</span></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="reading_date" class="form-label">
                                    Reading Date *
                                    <i class="fas fa-question-circle help-icon" 
                                       data-bs-toggle="tooltip" 
                                       title="Date when the meter reading was taken"></i>
                                </label>
                                <input type="date" class="form-control" id="reading_date" name="reading_date" required>
                                <small class="form-text text-muted">
                                    <i class="fas fa-calendar"></i> Default is today's date
                                </small>
                                <div class="invalid-feedback">
                                    Please select a valid reading date.
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="current_reading" class="form-label">
                                    Current Reading *
                                    <i class="fas fa-question-circle help-icon" 
                                       data-bs-toggle="tooltip" 
                                       title="Enter the current meter reading value as shown on the meter"></i>
                                </label>
                                <div class="input-group">
                                    <input type="number" step="0.01" class="form-control" id="current_reading" 
                                           name="current_reading" required min="0" placeholder="0.00" 
                                           onchange="calculateConsumption()">
                                    <span class="input-group-text">units</span>
                                </div>
                                <small class="form-text text-muted">
                                    <i class="fas fa-tachometer-alt"></i> Enter the current meter reading in units
                                </small>
                                <div class="invalid-feedback">
                                    Please enter a valid meter reading.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Consumption Calculation Display -->
                    <div id="consumptionDisplay" class="alert alert-light" style="display: none;">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <h6 class="text-muted">Previous Reading</h6>
                                <h4 id="displayPrevious">0.00</h4>
                                <small>units</small>
                            </div>
                            <div class="col-md-3">
                                <h6 class="text-primary">Current Reading</h6>
                                <h4 id="displayCurrent">0.00</h4>
                                <small>units</small>
                            </div>
                            <div class="col-md-3">
                                <h6 class="text-success">Consumption</h6>
                                <h4 id="displayConsumption" class="text-success">0.00</h4>
                                <small>units</small>
                            </div>
                            <div class="col-md-3">
                                <h6 class="text-info">Estimated Cost</h6>
                                <h4 id="displayCost" class="text-info">₹0.00</h4>
                                <small>at ₹70/unit</small>
                            </div>
                        </div>
                        
                        <!-- Consumption Level Indicator -->
                        <div class="mt-3 text-center">
                            <span id="consumptionLevel" class="badge bg-secondary">Normal</span>
                            <small class="text-muted d-block mt-1" id="consumptionAdvice">
                                Consumption level will be analyzed after entering reading
                            </small>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save"></i> Save Reading
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-lg" onclick="resetForm()">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        <a href="{{ url_for('meter_readings') }}" class="btn btn-secondary btn-lg">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Reading Guidelines Card -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-lightbulb"></i> Reading Guidelines</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6><i class="fas fa-eye text-primary"></i> Taking Readings</h6>
                    <small>Record the exact number shown on the water meter. Include decimal places if visible.</small>
                </div>
                <div class="mb-3">
                    <h6><i class="fas fa-calendar text-success"></i> Timing</h6>
                    <small>Take readings at the same time each month for consistency. End of month is recommended.</small>
                </div>
                <div class="mb-3">
                    <h6><i class="fas fa-chart-line text-info"></i> Consumption Levels</h6>
                    <ul class="small mb-0">
                        <li><span class="badge bg-success">Low:</span> 0-10 units</li>
                        <li><span class="badge bg-warning">Normal:</span> 10-30 units</li>
                        <li><span class="badge bg-danger">High:</span> >30 units</li>
                    </ul>
                </div>
                <div>
                    <h6><i class="fas fa-exclamation-triangle text-warning"></i> Important</h6>
                    <small>Double-check readings for accuracy. Incorrect readings affect billing calculations.</small>
                </div>
            </div>
        </div>
        
        <!-- Recent Readings Card -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-clock"></i> Recent Readings</h6>
            </div>
            <div class="card-body">
                <div class="small">
                    <div class="mb-2">
                        <strong>A001:</strong> 1,250.5 units<br>
                        <small class="text-muted">15.5 units consumed • 2 hours ago</small>
                    </div>
                    <div class="mb-2">
                        <strong>B-12:</strong> 892.0 units<br>
                        <small class="text-muted">22.0 units consumed • 1 day ago</small>
                    </div>
                    <div>
                        <strong>C005:</strong> 1,105.75 units<br>
                        <small class="text-muted">18.25 units consumed • 2 days ago</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Tips Card -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-tips"></i> Quick Tips</h6>
            </div>
            <div class="card-body">
                <div class="small">
                    <div class="mb-2">
                        <i class="fas fa-check-circle text-success"></i>
                        Verify meter is not running while reading
                    </div>
                    <div class="mb-2">
                        <i class="fas fa-check-circle text-success"></i>
                        Check for any meter damage or leaks
                    </div>
                    <div class="mb-2">
                        <i class="fas fa-check-circle text-success"></i>
                        Take a photo for your records
                    </div>
                    <div>
                        <i class="fas fa-check-circle text-success"></i>
                        Report any unusual consumption patterns
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let previousReadingValue = 0;

// Load house information when selected
function loadHouseInfo() {
    const houseSelect = document.getElementById('house_id');
    const selectedOption = houseSelect.options[houseSelect.selectedIndex];
    const houseInfoCard = document.getElementById('houseInfoCard');
    
    if (houseSelect.value) {
        const houseNumber = selectedOption.getAttribute('data-house-number');
        const ownerName = selectedOption.getAttribute('data-owner');
        
        document.getElementById('selectedHouse').textContent = houseNumber;
        document.getElementById('selectedOwner').textContent = ownerName;
        
        // In a real implementation, fetch the last reading from server
        // For demo, we'll simulate this
        fetchLastReading(houseSelect.value);
        
        houseInfoCard.style.display = 'block';
        houseSelect.classList.remove('is-invalid');
        houseSelect.classList.add('is-valid');
    } else {
        houseInfoCard.style.display = 'none';
        document.getElementById('consumptionDisplay').style.display = 'none';
        houseSelect.classList.remove('is-valid');
    }
}

// Fetch actual last reading from server
async function fetchLastReading(houseId) {
    try {
        const response = await fetch(`/api/house_last_reading/${houseId}`);
        
        if (!response.ok) {
            throw new Error('Failed to fetch last reading');
        }
        
        const data = await response.json();
        
        // Update the UI with real data
        document.getElementById('lastReading').textContent = data.reading > 0 ? 
            `${data.reading.toFixed(2)} units` : 'No previous readings';
        document.getElementById('lastReadingDate').textContent = data.date;
        
        // Store the actual previous reading value
        previousReadingValue = data.reading;
        
        // If there's already a current reading entered, recalculate
        const currentReadingInput = document.getElementById('current_reading');
        if (currentReadingInput.value) {
            calculateConsumption();
        }
        
    } catch (error) {
        console.error('Error fetching last reading:', error);
        
        // Fallback in case of error
        document.getElementById('lastReading').textContent = 'Error loading reading';
        document.getElementById('lastReadingDate').textContent = 'Error';
        previousReadingValue = 0;
        
        // Show error message
        showToast('Error loading previous reading. Please refresh and try again.', 'error');
    }
}

// Helper function to show toast messages (optional - you can use your existing notification system)
function showToast(message, type = 'info') {
    // You can replace this with SweetAlert or your preferred notification system
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: type === 'error' ? 'error' : 'info',
            title: message,
            showConfirmButton: false,
            timer: 3000
        });
    } else {
        // Fallback to console if no notification system
        console.log(`${type.toUpperCase()}: ${message}`);
    }
}

// Calculate consumption in real-time
function calculateConsumption() {
    const currentReading = parseFloat(document.getElementById('current_reading').value) || 0;
    const consumption = Math.max(0, currentReading - previousReadingValue);
    const estimatedCost = consumption * 70; // ₹70 per unit
    
    // Update display
    document.getElementById('displayPrevious').textContent = previousReadingValue.toFixed(2);
    document.getElementById('displayCurrent').textContent = currentReading.toFixed(2);
    document.getElementById('displayConsumption').textContent = consumption.toFixed(2);
    document.getElementById('displayCost').textContent = `₹${estimatedCost.toFixed(2)}`;
    
    // Update consumption level and advice
    updateConsumptionLevel(consumption);
    
    // Show consumption display
    document.getElementById('consumptionDisplay').style.display = 'block';
    
    // Validate current reading
    const currentReadingInput = document.getElementById('current_reading');
    if (currentReading < previousReadingValue) {
        currentReadingInput.classList.add('is-invalid');
        currentReadingInput.setCustomValidity('Current reading cannot be less than previous reading');
    } else {
        currentReadingInput.classList.remove('is-invalid');
        currentReadingInput.classList.add('is-valid');
        currentReadingInput.setCustomValidity('');
    }
}

function updateConsumptionLevel(consumption) {
    const levelElement = document.getElementById('consumptionLevel');
    const adviceElement = document.getElementById('consumptionAdvice');
    
    if (consumption === 0) {
        levelElement.className = 'badge bg-secondary';
        levelElement.innerHTML = '<i class="fas fa-minus"></i> No Consumption';
        adviceElement.textContent = 'Zero consumption detected. Please verify meter reading.';
    } else if (consumption < 10) {
        levelElement.className = 'badge bg-success';
        levelElement.innerHTML = '<i class="fas fa-leaf"></i> Low Consumption';
        adviceElement.textContent = 'Excellent! Low water usage is environmentally friendly.';
    } else if (consumption <= 30) {
        levelElement.className = 'badge bg-warning';
        levelElement.innerHTML = '<i class="fas fa-tint"></i> Normal Consumption';
        adviceElement.textContent = 'Normal consumption range for a typical household.';
    } else if (consumption <= 50) {
        levelElement.className = 'badge bg-danger';
        levelElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> High Consumption';
        adviceElement.textContent = 'High consumption detected. Please check for leaks or unusual usage.';
    } else {
        levelElement.className = 'badge bg-danger';
        levelElement.innerHTML = '<i class="fas fa-warning"></i> Very High Consumption';
        adviceElement.textContent = 'Unusually high consumption! Please verify reading and check for leaks immediately.';
    }
}

function resetForm() {
    Swal.fire({
        title: 'Reset Form?',
        text: 'This will clear all entered data.',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, Reset',
        cancelButtonText: 'Keep Data'
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById('meterReadingForm').reset();
            document.getElementById('houseInfoCard').style.display = 'none';
            document.getElementById('consumptionDisplay').style.display = 'none';
            document.querySelectorAll('.form-control, .form-select').forEach(input => {
                input.classList.remove('is-valid', 'is-invalid');
            });
            
            // Set today's date again
            document.getElementById('reading_date').value = new Date().toISOString().split('T')[0];
            
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'Form reset successfully',
                showConfirmButton: false,
                timer: 2000
            });
        }
    });
}

// Enhanced form validation
document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default
    document.getElementById('reading_date').value = new Date().toISOString().split('T')[0];
    
    // Add real-time validation
    const form = document.getElementById('meterReadingForm');
    const inputs = form.querySelectorAll('input[required], select[required]');
    
    inputs.forEach(input => {
        input.addEventListener('blur', function() {
            validateField(this);
        });
        
        input.addEventListener('input', function() {
            if (this.classList.contains('is-invalid')) {
                validateField(this);
            }
        });
    });
    
    // Form submission validation
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        let isValid = true;
        inputs.forEach(input => {
            if (!validateField(input)) {
                isValid = false;
            }
        });
        
        if (!isValid) {
            Swal.fire({
                title: 'Validation Error',
                text: 'Please fix the highlighted errors before submitting.',
                icon: 'error',
                confirmButtonColor: '#dc2626'
            });
            return;
        }
        
        // Additional validation for reading logic
        const currentReading = parseFloat(document.getElementById('current_reading').value);
        const consumption = currentReading - previousReadingValue;
        
        if (consumption > 100) {
            const result = await Swal.fire({
                title: 'High Consumption Warning',
                text: `The calculated consumption (${consumption.toFixed(2)} units) is very high. Are you sure this reading is correct?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, Continue',
                cancelButtonText: 'Let me check again'
            });
            
            if (!result.isConfirmed) {
                return;
            }
        }
        
        // Final confirmation
        const houseInfo = document.getElementById('selectedHouse').textContent;
        const result = await Swal.fire({
            title: 'Save Meter Reading?',
            text: `Save reading of ${currentReading.toFixed(2)} units for house ${houseInfo}?\n\nConsumption: ${consumption.toFixed(2)} units`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, Save Reading',
            cancelButtonText: 'Cancel'
        });
        
        if (result.isConfirmed) {
            // Show loading state
            const submitBtn = document.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            try {
                // Create FormData and submit via fetch
                const formData = new FormData(this);
                
                const response = await fetch(this.action || window.location.pathname, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    // Check if response is a redirect (successful form submission)
                    if (response.redirected) {
                        Swal.fire({
                            title: 'Success!',
                            text: 'Meter reading saved successfully!',
                            icon: 'success',
                            timer: 2000,
                            showConfirmButton: false
                        }).then(() => {
                            window.location.href = response.url;
                        });
                    } else {
                        // Handle JSON response if any
                        const result = await response.text();
                        window.location.href = '/meter_readings'; // Redirect to meter readings page
                    }
                } else {
                    throw new Error('Server error');
                }
                
            } catch (error) {
                console.error('Error submitting form:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to save meter reading. Please try again.',
                    icon: 'error'
                });
                
                // Restore button state
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }
    });
});

function validateField(input) {
    const value = input.value.trim();
    const isRequired = input.hasAttribute('required');
    
    input.classList.remove('is-valid', 'is-invalid');
    
    if (isRequired && !value) {
        input.classList.add('is-invalid');
        return false;
    }
    
    if (input.type === 'number' && value) {
        const numValue = parseFloat(value);
        if (isNaN(numValue) || numValue < 0) {
            input.classList.add('is-invalid');
            return false;
        }
    }
    
    if (input.type === 'date' && value) {
        const selectedDate = new Date(value);
        const today = new Date();
        const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
        
        if (selectedDate > today) {
            input.classList.add('is-invalid');
            input.setCustomValidity('Reading date cannot be in the future');
            return false;
        } else if (selectedDate < thirtyDaysAgo) {
            input.classList.add('is-invalid');
            input.setCustomValidity('Reading date cannot be more than 30 days old');
            return false;
        } else {
            input.setCustomValidity('');
        }
    }
    
    if (value || !isRequired) {
        input.classList.add('is-valid');
    }
    
    return true;
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey) {
        switch(e.key) {
            case 's':
                e.preventDefault();
                document.getElementById('meterReadingForm').requestSubmit();
                break;
            case 'r':
                e.preventDefault();
                resetForm();
                break;
        }
    }
});
</script>
{% endblock %}